// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  status    String   // A: Admin, C: Construction Manager, W: Write, R: Read-only
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  managedLevels     Level[] // Levels where this user is construction manager
  permissions       Permission[]
}

model Level {
  id                   Int      @id @default(autoincrement())
  name                 String
  description          String?
  parentId             Int?
  parent               Level?   @relation("LevelHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children             Level[]  @relation("LevelHierarchy")
  startDate            DateTime?
  endDate              DateTime?
  completed            Boolean  @default(false)
  notes                String?
  coverImage           String?  // For root levels
  constructionManagerId Int?
  constructionManager  User?   @relation(fields: [constructionManagerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  materials   Material[]
  photos      Photo[]
  permissions Permission[]
}

model Material {
  id             Int      @id @default(autoincrement())
  levelId        Int
  level          Level    @relation(fields: [levelId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  description    String
  quantity       Float
  estimatedValue Float
  realValue      Float?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Photo {
  id        Int      @id @default(autoincrement())
  levelId   Int
  level     Level    @relation(fields: [levelId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  type      String   // before, inprogress, completed
  url       String   // Azure Blob URL
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permission {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  levelId    Int
  level      Level    @relation(fields: [levelId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  permission String   // W: Write, R: Read-only
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, levelId])
}
